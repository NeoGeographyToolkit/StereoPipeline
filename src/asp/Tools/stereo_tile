#!/usr/bin/env python
# __BEGIN_LICENSE__
#  Copyright (c) 2009-2026, United States Government as represented by the
#  Administrator of the National Aeronautics and Space Administration. All
#  rights reserved.
#
#  The NGT platform is licensed under the Apache License, Version 2.0 (the
#  "License"); you may not use this file except in compliance with the
#  License. You may obtain a copy of the License at
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
# __END_LICENSE__

"""
stereo_tile - Process a single tile for distributed stereo.
"""

import sys, argparse, subprocess, re, os, math, time, glob, shutil, platform
import os.path as P

# Set up the path to Python modules about to load
basepath    = os.path.abspath(sys.path[0])
pythonpath  = os.path.abspath(basepath + '/../Python')  # for dev ASP
libexecpath = os.path.abspath(basepath + '/../libexec') # for packaged ASP
sys.path.insert(0, basepath) # prepend to Python path
sys.path.insert(0, pythonpath)
sys.path.insert(0, libexecpath)
# Import after setting up the paths
import asp_system_utils, asp_string_utils, asp_cmd_utils, asp_stereo_utils, asp_alg_utils
asp_system_utils.verify_python_version_is_supported()

# Prepend to system PATH
os.environ["PATH"] = libexecpath + os.pathsep + os.environ["PATH"]

# Ensure we can look up the ASP libraries
if 'ASP_LIBRARY_PATH' in os.environ:
    os.environ['LD_LIBRARY_PATH'] = os.environ['ASP_LIBRARY_PATH']

def symlink_stats_files(out_prefix, tile_subdir, tile_prefix):
    '''Symlink stats files from parent directory to tile subdir.'''
    for f in glob.glob(out_prefix + '*stats.tif'):
        if os.path.isdir(f):
            continue
        rel_src = os.path.relpath(f, tile_subdir)
        dst_f = f.replace(out_prefix, tile_prefix)
        if not os.path.lexists(dst_f):
            os.symlink(rel_src, dst_f)

def read_tile_list(out_prefix, tile_index):
    '''Read the tile list file and return (BBox, padding) for the given tile index.'''
    tile_list_file = out_prefix + '-distTileList.txt'
    if not os.path.exists(tile_list_file):
        asp_system_utils.raise_error('Tile list file not found: ' + tile_list_file)

    tiles = []
    with open(tile_list_file, 'r') as f:
        for line in f:
            line = line.strip()
            if not line:
                continue
            parts = line.split()
            if len(parts) != 5:
                asp_system_utils.raise_error('Invalid tile list line: ' + line)
            x, y, width, height, padding = [int(p) for p in parts]
            tiles.append((asp_alg_utils.BBox(x, y, width, height), padding))

    if tile_index < 0 or tile_index >= len(tiles):
        asp_system_utils.raise_error('Tile index ' + str(tile_index) +
                                     ' out of range [0, ' + str(len(tiles) - 1) + ']')

    return tiles[tile_index]

if __name__ == '__main__':
    usage = '''stereo_tile [options] <images> [<cameras>]
                  <output_file_prefix> [DEM]
        Process a single tile for distributed stereo.\n''' + asp_system_utils.get_asp_version()

    p = argparse.ArgumentParser(usage=usage)
    p.add_argument('-v', '--version', dest='version', default=False, action='store_true',
                   help='Display the version of software.')
    p.add_argument('--verbose', dest='verbose', default=False, action='store_true',
                   help='Display the commands being executed.')
    p.add_argument('--dry-run', dest='dryrun', default=False, action='store_true',
                   help='Do not launch the jobs, only print the commands that should be run.')
    p.add_argument('--tile-index', dest='tile_index', default=None, type=int,
                   help='Index of the tile to process (0-based).')
    p.add_argument('-e', '--entry-point', dest='entry_point', default=0, type=int,
                   help='Stereo pipeline entry point (0=pprc, 1=corr, 2=blend, 3=rfne, 4=fltr, 5=tri).')
    p.add_argument('--stop-point', dest='stop_point', default=6, type=int,
                   help='Stereo pipeline stop point (stop before this step).')

    (opt, args) = p.parse_known_args()
    args = asp_cmd_utils.clean_args(args)

    if opt.version:
        asp_system_utils.print_version_and_exit()

    if not args and not opt.version:
        p.print_help()
        asp_system_utils.raise_error('\nERROR: Missing input files', code=2)

    if opt.tile_index is None:
        asp_system_utils.raise_error('\nERROR: --tile-index is required', code=2)

    # Run stereo_parse to get settings
    sep = ","
    settings = asp_system_utils.run_and_parse_output("stereo_parse", args, sep,
                                                      opt.verbose)
    out_prefix = settings['out_prefix'][0]

    print("Output prefix: " + out_prefix)
    print("Tile index: " + str(opt.tile_index))

    (tile, padding) = read_tile_list(out_prefix, opt.tile_index)
    print("Tile: " + tile.name_str() + ", padding: " + str(padding))

    # Create tile subdir
    tile_subdir = out_prefix + '-' + tile.name_str()
    asp_system_utils.mkdir_p(tile_subdir)
    tile_prefix = tile_subdir + '/' + os.path.basename(out_prefix)

    # Symlink stats files to the subdir
    symlink_stats_files(out_prefix, tile_subdir, tile_prefix)

    # Common extra args for all steps. For now only --corr-seed-mode 0 is supported,
    # so D_sub is avoided. 
    # TODO(oalexan1): Enable using --corr-seed-mode 2 and 3. Maybe that will require
    # seeding directly D.tif.
    extra_args = ['--output-prefix-override', tile_prefix,
                  '--stereo-dist-mode',
                  '--skip-low-res-disparity-comp',
                  '--corr-seed-mode', '0',
                  '--left-image-crop-win',
                  str(tile.x), str(tile.y), str(tile.width), str(tile.height),
                  '--sgm-collar-size', str(padding)]

    Step = asp_stereo_utils.Step

    if opt.entry_point <= Step.pprc < opt.stop_point:
        asp_stereo_utils.stereo_run('stereo_pprc', args, opt, extra_args=extra_args)

    if opt.entry_point <= Step.corr < opt.stop_point:
        asp_stereo_utils.stereo_run('stereo_corr', args, opt, extra_args=extra_args)

    # Skip blend for now - it requires dirList.txt with all tile directories.
    # TODO(oalexan1): Ensure dirList.txt is compatible with stereo_tile tiling logic.
    # stereo_dist will run all tiles for corr, then all tiles for blend with cross-talk.

    if opt.entry_point <= Step.rfne < opt.stop_point:
        asp_stereo_utils.stereo_run('stereo_rfne', args, opt, extra_args=extra_args)

    if opt.entry_point <= Step.fltr < opt.stop_point:
        asp_stereo_utils.stereo_run('stereo_fltr', args, opt, extra_args=extra_args)

    if opt.entry_point <= Step.tri < opt.stop_point:
        asp_stereo_utils.stereo_run('stereo_tri', args, opt, extra_args=extra_args)

    sys.exit(0)
