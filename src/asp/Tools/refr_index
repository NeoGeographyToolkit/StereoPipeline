#!/usr/bin/env python
# __BEGIN_LICENSE__
#  Copyright (c) 2009-2026, United States Government as represented by the
#  Administrator of the National Aeronautics and Space Administration. All
#  rights reserved.
#
#  The NGT platform is licensed under the Apache License, Version 2.0 (the
#  "License"); you may not use this file except in compliance with the
#  License. You may obtain a copy of the License at
#  http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
# __END_LICENSE__

"""
Compute the effective refractive index of water for a given temperature, salinity,
and wavelength or spectral response. Uses the Parrish empirical equation.

Reference: https://research.engr.oregonstate.edu/parrish/index-refraction-seawater-and-freshwater-function-wavelength-and-temperature
"""

import sys
import os
import argparse
import numpy as np

# Set up the path to Python modules about to load
basepath    = os.path.abspath(sys.path[0])
pythonpath  = os.path.abspath(basepath + '/../Python')  # for dev ASP
libexecpath = os.path.abspath(basepath + '/../libexec') # for packaged ASP
sys.path.insert(0, basepath) # prepend to Python path
sys.path.insert(0, pythonpath)
sys.path.insert(0, libexecpath)

import asp_system_utils

# Prepend to system PATH
os.environ["PATH"] = libexecpath + os.pathsep + os.environ["PATH"]

# Define wavelength limits (in nm). The first range is from the Parrish equation
# documentation, the second is a hard error for sanity checking. The spectral
# response tables from vendors usually go beyond the strict Parrish limits, but
# have small responses outside the valid range.
min_wl_warn = 400
max_wl_warn = 700
min_wl_err  = 300
max_wl_err  = 1100

def read_csv(filename):
    wavelengths = []
    responses = []
    warn_range = False
    try:
        with open(filename, 'r') as f:
            lines = f.readlines()
            if not lines:
                print("Error: Empty spectral response file.")
                sys.exit(1)
            
            # Skip header
            for line in lines[1:]:
                line = line.strip()
                if not line:
                    continue
                # Handle comma or space delimiters
                parts = line.replace(',', ' ').split()
                if len(parts) < 2:
                    continue
                
                try:
                    wl = float(parts[0])
                    resp = float(parts[1])
                except ValueError:
                    print(f"Warning: Skipping invalid line: {line}", file=sys.stderr)
                    continue
                
                # Only include positive responses
                if resp <= 0:
                    continue
                    
                # Check wavelength range
                if wl < min_wl_warn or wl > max_wl_warn:
                    warn_range = True

                # Hard error for extreme values (sanity check)
                if wl < min_wl_err or wl > max_wl_err:
                    print(f"Error: Wavelength {wl} nm is out of supported range " + 
                          f"({min_wl_err}-{max_wl_err} nm).")
                    sys.exit(1)
                
                wavelengths.append(wl)
                responses.append(resp)
                
        if warn_range:
            print(f"Warning: Some wavelengths are outside the valid range of {min_wl_warn}-{max_wl_warn} nm "
                  "for the Parrish equation. Results may be inaccurate.", file=sys.stderr)

    except Exception as e:
        print(f"Error reading spectral response file: {e}")
        sys.exit(1)

    if not wavelengths:
        print("Error: No valid data found in spectral response file.")
        sys.exit(1)
    
    if not responses:
        print("Error: No valid responses found in spectral response file.")
        sys.exit(1)
        
    return np.array(wavelengths), np.array(responses)

def main():
    usage = "refr_index --salinity <val> --temperature <val> [--spectral-response <file> | --wavelength <val>]"
    parser = argparse.ArgumentParser(usage=usage,
                                     description="Compute effective refraction index.")

    parser.add_argument('--salinity', type=float, default=-1.0,
                        help='Salinity in parts per thousand (ppt).')
    parser.add_argument('--temperature', type=float, default=-1.0,
                        help='Temperature in degrees Celsius.')
    
    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument('--spectral-response', type=str, default="",
                        help='CSV file containing the spectral response.')
    group.add_argument('--wavelength', type=float, default=-1.0,
                        help='Calculate the refraction index for a single wavelength (in nm).')

    parser.add_argument('-v', '--version', action='store_true',
                        help='Display the version of software.')

    args = parser.parse_args()

    if args.version:
        asp_system_utils.print_version_and_exit()

    # Input validation
    if args.salinity == -1.0:
        print("Error: --salinity must be specified.")
        sys.exit(1)
    if args.temperature == -1.0:
        print("Error: --temperature must be specified.")
        sys.exit(1)

    if args.salinity < 0:
        print("Error: Salinity must be non-negative.")
        sys.exit(1)

    if not (0 <= args.temperature <= 30):
        print("Error: Temperature must be between 0 and 30 degrees Celsius.")
        sys.exit(1)

    # Coefficients for Parrish empirical equation
    # n = a*T^2 + b*lambda^2 + c*T + d*lambda + e
    # Reference: https://research.engr.oregonstate.edu/parrish/index-refraction-seawater-and-freshwater-function-wavelength-and-temperature
    
    # Seawater (S = 35)
    params_35 = {
        'a': -1.50156e-6,
        'b': 1.07085e-7,
        'c': -4.27594e-5,
        'd': -1.60476e-4,
        'e': 1.39807
    }

    # Freshwater (S = 0)
    params_0 = {
        'a': -1.97812e-6,
        'b': 1.03223e-7,
        'c': -8.58125e-6,
        'd': -1.54834e-4,
        'e': 1.38919
    }

    # Linearly interpolate coefficients based on salinity
    s_factor = args.salinity / 35.0
    params = {}
    for key in params_0:
        params[key] = params_0[key] + s_factor * (params_35[key] - params_0[key])

    if args.spectral_response:
        if not os.path.exists(args.spectral_response):
            print(f"Error: Spectral response file not found: {args.spectral_response}")
            sys.exit(1)
        # Read spectral response
        wavelengths, responses = read_csv(args.spectral_response)
        
        if len(wavelengths) == 0:
            print("Error: No valid wavelengths found in spectral response file.")
            sys.exit(1)
        if len(responses) == 0:
            print("Error: No valid responses found in spectral response file.")
            sys.exit(1)
    else:
        # Single wavelength case
        wl = args.wavelength
        # Check wavelength range
        if wl < min_wl_warn or wl > max_wl_warn:
             print(f"Warning: Wavelength is outside the valid range of {min_wl_warn}-{max_wl_warn} nm "
                   "for the Parrish equation. Result may be inaccurate.", file=sys.stderr)
        if wl < min_wl_err or wl > max_wl_err:
             print(f"Error: Wavelength {wl} nm is out of supported range " + 
                   f"({min_wl_err}-{max_wl_err} nm).")
             sys.exit(1)
        wavelengths = np.array([wl])
        responses = np.array([1.0])

    if np.sum(responses) == 0:
        print("Error: Sum of spectral responses is zero.")
        sys.exit(1)

    # Compute refractive index for each wavelength
    # n = a*T^2 + b*lambda^2 + c*T + d*lambda + e
    T = args.temperature
    lam = wavelengths
    
    n_values = (params['a'] * T**2 +
                params['b'] * lam**2 +
                params['c'] * T +
                params['d'] * lam +
                params['e'])

    # Compute weighted average
    effective_index = np.sum(n_values * responses) / np.sum(responses)

    print(f"Effective index: {effective_index:.6f}")

if __name__ == "__main__":
    main()
